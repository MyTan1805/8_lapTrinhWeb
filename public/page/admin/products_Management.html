<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý sản phẩm - Admin Panel</title>
  <link rel="stylesheet" href="../../assets/css/admin.css">
  <style>
    .delete-many-btn {
      display: none; /* Ẩn mặc định */
      background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%);
      color: #FFFFFF;
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.3s ease, opacity 0.3s ease;
      box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
      opacity: 0; /* Start hidden */
      margin-left: 10px; /* Add some space */
    }
    .delete-many-btn:hover {
      background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);
      transform: scale(1.05);
    }
    .delete-many-btn.visible {
      display: inline-block; /* Make visible */
      opacity: 1;
    }
    .select-all-checkbox {
      margin-right: 5px;
    }
    /* Basic Loading Indicator Style */
    #loading {
        display: none; /* Hidden by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        z-index: 1001; /* Above modal */
        text-align: center;
        padding-top: 20%;
        font-size: 1.5em;
        color: #333;
    }
    /* Advanced Search Styles (Copied from edit_many_product.html) */
    .search-form {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .search-form label {
      margin-right: 5px;
    }
    .search-form input,
    .search-form select {
      padding: 8px;
      width: 150px;
    }
    .search-form .range-input {
      width: 80px;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>ADMIN PANEL</h2>
    </div>
    <nav class="sidebar-nav">
      <a href="/" class="nav-item active">
        <span class="nav-icon">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 5H17V15H3V5Z" stroke="#666666" stroke-width="2"/>
          </svg>
        </span>
        Dashboard
      </a>
      <a href="products_Management" class="nav-item">
        <span class="nav-icon">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 5H17V15H3V5Z" stroke="#666666" stroke-width="2"/>
          </svg>
        </span>
        Sản phẩm
        <span class="nav-arrow">
          <svg width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 1L5 5L9 1" stroke="#666666" stroke-width="2"/>
          </svg>
        </span>
      </a>
      <div class="sub-menu">
        <a href="products_Management" class="sub-item">Tất cả sản phẩm</a>
        <a href="add_product" class="sub-item">Thêm sản phẩm</a>
        <a href="edit_many_product" class="sub-item">Chỉnh sửa nhiều</a>
      </div>
    </nav>
  </aside>

  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h1>Quản lý sản phẩm</h1>
        <div class="header-actions">
          <a href="/" class="btn btn-secondary">Trở về trang chủ</a>
          <button class="delete-many-btn" id="deleteManyBtn">Xóa Sản Phẩm Đã Chọn</button>
          <a href="add_product" class="btn btn-primary">+ Thêm sản phẩm</a>
        </div>
      </div>
      <!-- Advanced Search Form -->
      <form id="search-form" class="search-form" method="get">
        <div>
          <label for="ten">Tên sản phẩm:</label>
          <input type="text" id="ten" name="ten">
        </div>
        <div>
          <label for="loai">Danh mục:</label>
          <select id="loai" name="loai">
            <option value="">Tất cả</option>
            <option value="Serum">Serum</option>
            <option value="Kem Chống Nắng">Kem Chống Nắng</option>
            <option value="Sữa Rửa Mặt">Sữa Rửa Mặt</option>
            <option value="Toner">Toner</option>
            <option value="Kem Dưỡng">Kem Dưỡng</option>
            <option value="Tinh Chất">Tinh Chất</option>
            <option value="Tẩy Tế Bào Chết">Tẩy Tế Bào Chết</option>
            <option value="Xịt Khoáng">Xịt Khoáng</option>
            <option value="Tẩy Trang">Tẩy Trang</option>
            <option value="Kem Dưỡng Mắt">Kem Dưỡng Mắt</option>
            <option value="Mặt Nạ Ngủ">Mặt Nạ Ngủ</option>
            <option value="Gel Dưỡng">Gel Dưỡng</option>
            <option value="Bộ Dưỡng Da">Bộ Dưỡng Da</option>
            <option value="Mặt Nạ">Mặt Nạ</option>
            <option value="Sữa Tắm">Sữa Tắm</option>
            <option value="Dầu Dưỡng">Dầu Dưỡng</option>
            <option value="Tinh Dầu">Tinh Dầu</option>
            <option value="Gel Trị Mụn">Gel Trị Mụn</option>
            <option value="Kem Lót">Kem Lót</option>
          </select>
        </div>
        <div>
          <label for="giaFr">Khoảng giá:</label>
          <input type="number" id="giaFr" name="giaFr" class="range-input" placeholder="Từ">
          <input type="number" id="giaTo" name="giaTo" class="range-input" placeholder="Đến">
        </div>
        <button type="submit" class="btn btn-primary">Tìm kiếm</button>
      </form>
      <div class="table-wrapper">
        <table class="product-table">
          <thead>
            <tr>
              <th><input type="checkbox" class="select-all-checkbox" id="selectAll" title="Chọn/Bỏ chọn tất cả trên trang này"></th>
              <th class="sortable" data-sort="id">ID</th>
              <th>Hình</th>
              <th class="sortable" data-sort="ten">Tên sản phẩm</th>
              <th class="sortable" data-sort="loaiHienThi">Danh mục</th>
              <th class="sortable" data-sort="price">Giá</th>
              <th class="sortable" data-sort="quantity">Còn hàng</th>
              <th>Trạng thái</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody id="productTableBody">
            <tr><td colspan="9" style="text-align: center; padding: 20px;">Đang tải dữ liệu...</td></tr>
          </tbody>
        </table>
      </div>
      <!-- Pagination Controls -->
      <div class="pagination">
        <button id="prevPage" class="btn btn-secondary" disabled>Quay lại</button>
        <span id="pageInfo">Trang 1 / 1</span>
        <button id="nextPage" class="btn btn-secondary" disabled>Tiếp theo</button>
      </div>
    </div>
  </main>

  <footer class="admin-footer">
    <div class="container">
      <p>© 2024 Mỹ Phẩm VN - Trang quản trị</p>
    </div>
  </footer>

  <!-- Loading Indicator Element -->
  <div id="loading">Đang xử lý...</div>

  <script>
    let products = [];
    let filteredProducts = [];
    let sortState = { column: null, direction: 'asc' };
    const productsPerPage = 7;
    let currentPage = 1;

    // DOM Elements
    const productTableBody = document.getElementById('productTableBody');
    const searchForm = document.getElementById('search-form');
    const selectAllCheckbox = document.getElementById('selectAll');
    const deleteManyBtn = document.getElementById('deleteManyBtn');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfoSpan = document.getElementById('pageInfo');
    const loadingIndicator = document.getElementById('loading');

    // Fetch products from the server
    async function fetchProducts() {
        productTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Đang tải dữ liệu...</td></tr>';
        try {
            const response = await fetch('/dishes');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            products = data.map(p => ({
                ...p,
                price: p.inventory?.price || 0,
                quantity: p.inventory?.quantity || 0
            }));
            filteredProducts = [...products];
            currentPage = 1;
            renderTable();
        } catch (error) {
            console.error("Lỗi khi tải dữ liệu sản phẩm:", error);
            productTableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 20px; color: red;">Không thể tải dữ liệu sản phẩm. Lỗi: ${error.message}</td></tr>`;
            alert(`Lỗi tải dữ liệu: ${error.message}`);
        }
    }

    // Render the product table content
    function renderTable() {
        sortProducts();
        productTableBody.innerHTML = '';

        const startIndex = (currentPage - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        const productsToRender = filteredProducts.slice(startIndex, endIndex);

        if (productsToRender.length === 0) {
            productTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Không tìm thấy sản phẩm nào.</td></tr>';
        } else {
            productsToRender.forEach(product => {
                const row = document.createElement('tr');
                const status = product.quantity > 0 ? 'Hoạt động' : 'Hết hàng';
                const statusClass = product.quantity > 0 ? 'active' : 'inactive';
                const priceDisplay = (product.price || 0).toLocaleString('vi-VN');
                const imageSrc = product.hinhAnh ? `/images/products/${encodeURIComponent(product.hinhAnh)}` : '/images/placeholder.png';

                row.innerHTML = `
                    <td><input type="checkbox" class="product-checkbox" data-id="${product.id}"></td>
                    <td>${product.id}</td>
                    <td><img src="${imageSrc}" alt="${product.ten}" class="product-image" onerror="this.onerror=null; this.src='/images/placeholder.png';"></td>
                    <td title="${product.ten}">${product.ten.length > 30 ? product.ten.substring(0, 30) + '...' : product.ten}</td>
                    <td>${product.loaiHienThi || product.loai || 'N/A'}</td>
                    <td>${priceDisplay} đ</td>
                    <td>${product.quantity || 0}</td>
                    <td><span class="status ${statusClass}">${status}</span></td>
                    <td>
                        <div class="action-wrapper">
                            <button class="action-btn" title="Thao tác">...</button>
                            <div class="action-dropdown">
                                <a href="/product_detail?id=${product.id}" target="_blank" class="action-item">Xem chi tiết</a>
                                <a href="/edit_product?id=${product.id}" class="action-item">Sửa</a>
                                <a href="#" class="action-item delete-btn" data-id="${product.id}">Xóa</a>
                            </div>
                        </div>
                    </td>
                `;
                productTableBody.appendChild(row);
            });
        }
        updatePaginationControls();
        updateSelectAllCheckboxState();
        toggleDeleteManyButton();
    }

    // --- Event Listeners ---

    // Search Form
    searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(searchForm);
        const ten = formData.get('ten');
        const loai = formData.get('loai');
        const giaFr = formData.get('giaFr') ? parseInt(formData.get('giaFr')) : null;
        const giaTo = formData.get('giaTo') ? parseInt(formData.get('giaTo')) : null;

        // Lọc sản phẩm (kiểu OR)
        filteredProducts = products.filter(product => {
            let match = false;

            // Lọc theo tên (regex, không phân biệt hoa thường)
            if (ten) {
                const regex = new RegExp(ten, 'i');
                if (regex.test(product.ten)) {
                    match = true;
                }
            }

            // Lọc theo danh mục
            if (loai) {
                if (product.loai === loai) {
                    match = true;
                }
            }

            // Lọc theo giá
            if (giaFr && giaTo) {
                if (product.inventory.price >= giaFr && product.inventory.price <= giaTo) {
                    match = true;
                }
            } else if (giaFr) {
                if (product.inventory.price >= giaFr) {
                    match = true;
                }
            } else if (giaTo) {
                if (product.inventory.price <= giaTo) {
                    match = true;
                }
            }

            // Nếu không có điều kiện nào được nhập, hiển thị tất cả
            if (!ten && !loai && !giaFr && !giaTo) {
                match = true;
            }

            return match;
        });

        currentPage = 1;
        renderTable();
    });

    // Select All Checkbox
    selectAllCheckbox.addEventListener('change', function() {
        const checkboxesOnPage = productTableBody.querySelectorAll(".product-checkbox");
        checkboxesOnPage.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        toggleDeleteManyButton();
    });

    // Individual Product Checkbox (using event delegation)
    productTableBody.addEventListener('change', function(e) {
        if (e.target.classList.contains('product-checkbox')) {
            updateSelectAllCheckboxState();
            toggleDeleteManyButton();
        }
    });

    // Delete Button (using event delegation)
    productTableBody.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
            e.preventDefault();
            const button = e.target.classList.contains('delete-btn') ? e.target : e.target.closest('.delete-btn');
            const productId = button.getAttribute('data-id');
            if (productId) {
                showSingleDeleteModal(productId);
            }
        }
    });

    // Delete Many Button
    deleteManyBtn.addEventListener('click', function() {
        const checkedCheckboxes = productTableBody.querySelectorAll(".product-checkbox:checked");
        const productIds = Array.from(checkedCheckboxes).map(checkbox => checkbox.getAttribute("data-id"));

        if (productIds.length === 0) {
            alert("Vui lòng chọn ít nhất một sản phẩm để xóa!");
            return;
        }
        showMultiDeleteModal(productIds);
    });

    // Pagination Buttons
    prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    });

    nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTable();
        }
    });

    // Sorting Headers (using event delegation)
    document.querySelector('.product-table thead').addEventListener('click', (e) => {
        if (e.target.classList.contains('sortable')) {
            const column = e.target.getAttribute('data-sort');
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'asc';
            }
            document.querySelectorAll('.product-table th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            e.target.classList.add(sortState.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            renderTable();
        }
    });

    // --- Helper Functions ---

    // Sort products based on current sort state
    function sortProducts() {
        if (!sortState.column) return;

        const { column, direction } = sortState;
        const multiplier = direction === 'asc' ? 1 : -1;

        filteredProducts.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];

            if (column === 'price' || column === 'quantity') {
                valA = Number(valA) || 0;
                valB = Number(valB) || 0;
                return (valA - valB) * multiplier;
            } else {
                valA = String(valA || '').toLowerCase();
                valB = String(valB || '').toLowerCase();
                if (valA < valB) return -1 * multiplier;
                if (valA > valB) return 1 * multiplier;
                return 0;
            }
        });
    }

    // Update state of "Select All" checkbox based on current page's checkboxes
    function updateSelectAllCheckboxState() {
        const checkboxesOnPage = productTableBody.querySelectorAll('.product-checkbox');
        if (checkboxesOnPage.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            return;
        }
        const checkedCount = productTableBody.querySelectorAll('.product-checkbox:checked').length;

        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === checkboxesOnPage.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    // Toggle visibility of "Delete Many" button
    function toggleDeleteManyButton() {
        const checkedCount = productTableBody.querySelectorAll(".product-checkbox:checked").length;
        if (checkedCount > 0) {
            deleteManyBtn.classList.add("visible");
            deleteManyBtn.textContent = `Xóa ${checkedCount} sản phẩm đã chọn`;
        } else {
            deleteManyBtn.classList.remove("visible");
            deleteManyBtn.textContent = `Xóa sản phẩm đã chọn`;
        }
    }

    // Update pagination controls (buttons and page info)
    function updatePaginationControls() {
        const totalProducts = filteredProducts.length;
        const totalPages = Math.ceil(totalProducts / productsPerPage);

        pageInfoSpan.textContent = totalProducts > 0 ? `Trang ${currentPage} / ${totalPages}` : 'Không có dữ liệu';
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;

        selectAllCheckbox.disabled = productTableBody.querySelectorAll('.product-checkbox').length === 0;
    }

    // --- Modal and Deletion Logic ---

    // Show confirmation modal for single product deletion
    function showSingleDeleteModal(productId) {
        const product = products.find(p => p.id === productId);
        const productName = product ? product.ten : `ID ${productId}`;
        showModal(`Xác nhận xóa sản phẩm`,
                  `<p style="color: #666666; margin-bottom: 20px;">Bạn có chắc chắn muốn xóa sản phẩm <strong>${productName}</strong>?</p>`,
                  `<button class="btn btn-danger" onclick="confirmSingleDelete('${productId}')">Xóa</button>
                   <button class="btn btn-secondary" onclick="closeModal()">Hủy</button>`);
    }

    // Show confirmation modal for multiple product deletion
    function showMultiDeleteModal(productIds) {
        showModal(`Xác nhận xóa nhiều sản phẩm`,
                  `<p style="color: #666666; margin-bottom: 20px;">Bạn có chắc chắn muốn xóa <strong>${productIds.length}</strong> sản phẩm đã chọn?</p>`,
                  `<button class="btn btn-danger" onclick='confirmMultiDelete(${JSON.stringify(productIds)})'>Xóa ${productIds.length} sản phẩm</button>
                   <button class="btn btn-secondary" onclick="closeModal()">Hủy</button>`);
    }

    // Generic Modal Function
    function showModal(title, contentHtml, footerHtml) {
        closeModal();
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.id = "confirmActionModal";
        modal.style.cssText = `
            display: flex; justify-content: center; align-items: center;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 1000;
            opacity: 0; transition: opacity 0.3s ease;
        `;
        modal.innerHTML = `
            <div style="background: #FFFFFF; width: 90%; max-width: 450px; padding: 25px 30px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s ease;">
                <h3 style="color: #333333; margin-top: 0; margin-bottom: 15px; font-size: 1.3em;">${title}</h3>
                ${contentHtml}
                <div class="modal-actions" style="margin-top: 25px;">
                    ${footerHtml}
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        setTimeout(() => {
            modal.style.opacity = '1';
            modal.querySelector('div').style.transform = 'scale(1)';
        }, 10);
    }

    // Close any modal
    function closeModal() {
        const modal = document.getElementById("confirmActionModal");
        if (modal) {
            modal.style.opacity = '0';
            modal.querySelector('div').style.transform = 'scale(0.9)';
            setTimeout(() => modal.remove(), 300);
        }
    }

    // Confirm single delete action
    async function confirmSingleDelete(productId) {
        loadingIndicator.style.display = 'block';
        closeModal();
        try {
            const response = await fetch(`/dishes/${productId}`, { method: 'DELETE' });
            const data = await response.json();

            if (response.ok) {
                alert(data.message || `Xóa sản phẩm ${productId} thành công!`);
                products = products.filter(p => p.id !== productId);
                const formData = new FormData(searchForm);
                const ten = formData.get('ten');
                const loai = formData.get('loai');
                const giaFr = formData.get('giaFr') ? parseInt(formData.get('giaFr')) : null;
                const giaTo = formData.get('giaTo') ? parseInt(formData.get('giaTo')) : null;

                filteredProducts = products.filter(product => {
                    let match = false;

                    if (ten) {
                        const regex = new RegExp(ten, 'i');
                        if (regex.test(product.ten)) {
                            match = true;
                        }
                    }

                    if (loai) {
                        if (product.loai === loai) {
                            match = true;
                        }
                    }

                    if (giaFr && giaTo) {
                        if (product.inventory.price >= giaFr && product.inventory.price <= giaTo) {
                            match = true;
                        }
                    } else if (giaFr) {
                        if (product.inventory.price >= giaFr) {
                            match = true;
                        }
                    } else if (giaTo) {
                        if (product.inventory.price <= giaTo) {
                            match = true;
                        }
                    }

                    if (!ten && !loai && !giaFr && !giaTo) {
                        match = true;
                    }

                    return match;
                });
                const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
                if (currentPage > totalPages && totalPages > 0) {
                    currentPage = totalPages;
                } else if (filteredProducts.length === 0) {
                    currentPage = totalPages;
                }
                renderTable();
            } else {
                throw new Error(data.message || `Lỗi ${response.status}: Không thể xóa sản phẩm.`);
            }
        } catch (error) {
            console.error(`Lỗi khi xóa sản phẩm ${productId}:`, error);
            alert(`Lỗi khi xóa: ${error.message}`);
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    // Confirm multiple delete action
    async function confirmMultiDelete(productIds) {
        if (!Array.isArray(productIds) || productIds.length === 0) {
            alert("Không có ID sản phẩm nào để xóa.");
            return;
        }
        console.log("Xác nhận xóa các ID:", productIds);
        loadingIndicator.style.display = "block";
        closeModal();

        try {
            const response = await fetch("/dishes/bulk", {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ids: productIds }),
            });

            if (!response.ok) {
                let errorMsg = `Lỗi ${response.status}: ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.message || errorMsg;
                } catch (parseError) {
                    console.warn("Không thể parse JSON lỗi từ server:", parseError);
                }
                throw new Error(errorMsg);
            }

            const data = await response.json();
            alert(data.message || `Thực hiện xóa ${productIds.length} sản phẩm.`);
            await fetchProducts();

        } catch (error) {
            console.error("Lỗi khi xóa nhiều sản phẩm:", error);
            alert(`Lỗi khi xóa nhiều: ${error.message}`);
        } finally {
            loadingIndicator.style.display = "none";
            selectAllCheckbox.checked = false;
            toggleDeleteManyButton();
        }
    }

    document.addEventListener('DOMContentLoaded', fetchProducts);
  </script>
</body>
</html>