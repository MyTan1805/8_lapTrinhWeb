<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý sản phẩm - Admin Panel</title>
  <link rel="stylesheet" href="../../assets/css/admin.css">
  <style>
    .delete-many-btn {
      display: none; /* Ẩn mặc định */
      background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%);
      color: #FFFFFF;
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.3s ease, opacity 0.3s ease;
      box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
      opacity: 0; /* Start hidden */
      margin-left: 10px; /* Add some space */
    }
    .delete-many-btn:hover {
      background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);
      transform: scale(1.05);
    }
    .delete-many-btn.visible {
      display: inline-block; /* Make visible */
      opacity: 1;
    }
    .select-all-checkbox {
      margin-right: 5px;
    }
    /* Basic Loading Indicator Style */
    #loading {
        display: none; /* Hidden by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        z-index: 1001; /* Above modal */
        text-align: center;
        padding-top: 20%;
        font-size: 1.5em;
        color: #333;
    }
    /* Basic Toast Styles */
    #toast {
        position: fixed;
        bottom: 20px; /* Positioned at the bottom */
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 20px;
        border-radius: 25px; /* More rounded */
        color: #FFFFFF;
        z-index: 1002; /* Above loading */
        font-size: 0.9em;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        display: none; /* Use opacity and display for transitions */
        min-width: 250px;
        text-align: center;
    }
    #toast.show {
        display: block;
        opacity: 1;
    }
    #toast.success {
        background-color: #4CAF50; /* Green */
    }
    #toast.error {
        background-color: #f44336; /* Red */
    }
    #toast.warning {
        background-color: #ff9800; /* Orange */
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>ADMIN PANEL</h2>
    </div>
    <nav class="sidebar-nav">
      <!-- ... (rest of your sidebar) ... -->
       <a href="products_Management" class="nav-item active">
         <span class="nav-icon">
           <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
             <path d="M3 5H17V15H3V5Z" stroke="#666666" stroke-width="2"/>
           </svg>
         </span>
         Sản phẩm
         <span class="nav-arrow">
           <svg width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
             <path d="M1 1L5 5L9 1" stroke="#666666" stroke-width="2"/>
           </svg>
         </span>
       </a>
       <div class="sub-menu" style="display: block;"> <!-- Ensure submenu is visible -->
         <a href="products_Management" class="sub-item active">Tất cả sản phẩm</a>
         <a href="add_product" class="sub-item">Thêm sản phẩm</a>
         <a href="edit_many_product" class="sub-item">Chỉnh sửa nhiều</a>
         <!-- <a href="categories.html" class="sub-item">Danh mục</a> -->
       </div>
      <!-- ... -->
    </nav>
  </aside>

  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h1>Quản lý sản phẩm</h1>
        <div class="header-actions">
          <a href="/" class="btn btn-secondary">Trở về trang chủ</a>
          <button class="delete-many-btn" id="deleteManyBtn">Xóa Sản Phẩm Đã Chọn</button> <!-- Changed text slightly -->
          <a href="add_product" class="btn btn-primary">+ Thêm sản phẩm</a>
        </div>
      </div>
      <div class="search-bar">
        <input type="text" class="search-input" id="searchInput" placeholder="Tìm kiếm sản phẩm (Tên, Danh mục, ID)...">
        <span class="search-icon">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 16C12.866 16 16 12.866 16 9C16 5.13401 12.866 2 9 2C5.13401 2 2 5.13401 2 9C2 12.866 5.13401 16 9 16Z" stroke="#666666" stroke-width="2"/>
            <path d="M14 14L18 18" stroke="#666666" stroke-width="2"/>
          </svg>
        </span>
      </div>
      <div class="table-wrapper">
        <table class="product-table">
          <thead>
            <tr>
              <th><input type="checkbox" class="select-all-checkbox" id="selectAll" title="Chọn/Bỏ chọn tất cả trên trang này"></th>
              <th class="sortable" data-sort="id">ID</th>
              <th>Hình</th>
              <th class="sortable" data-sort="ten">Tên sản phẩm</th>
              <th class="sortable" data-sort="loaiHienThi">Danh mục</th> <!-- Sort by display name -->
              <th class="sortable" data-sort="price">Giá</th>
              <th class="sortable" data-sort="quantity">Còn hàng</th>
              <th>Trạng thái</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody id="productTableBody">
            <!-- Rows will be populated dynamically -->
            <tr><td colspan="9" style="text-align: center; padding: 20px;">Đang tải dữ liệu...</td></tr>
          </tbody>
        </table>
      </div>
      <!-- Pagination Controls -->
      <div class="pagination">
        <button id="prevPage" class="btn btn-secondary" disabled>Quay lại</button>
        <span id="pageInfo">Trang 1 / 1</span>
        <button id="nextPage" class="btn btn-secondary" disabled>Tiếp theo</button>
      </div>
    </div>
  </main>

  <footer class="admin-footer">
    <div class="container">
      <p>© 2024 Mỹ Phẩm VN - Trang quản trị</p>
      <!-- Removed redundant home link -->
    </div>
  </footer>

  <!-- Loading Indicator Element -->
  <div id="loading">Đang xử lý...</div>

  <!-- Toast Notification Element -->
  <div id="toast"></div>

  <script>
    let products = [];
    let filteredProducts = [];
    let sortState = { column: null, direction: 'asc' }; // Keep track of sort state
    const productsPerPage = 7;
    let currentPage = 1;

    // DOM Elements
    const productTableBody = document.getElementById('productTableBody');
    const searchInput = document.getElementById('searchInput');
    const selectAllCheckbox = document.getElementById('selectAll');
    const deleteManyBtn = document.getElementById('deleteManyBtn');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfoSpan = document.getElementById('pageInfo');
    const loadingIndicator = document.getElementById('loading');
    const toastElement = document.getElementById("toast");


    // Fetch products from the server
    async function fetchProducts() {
        productTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Đang tải dữ liệu...</td></tr>';
        try {
            const response = await fetch('/dishes');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            // Pre-process data for easier sorting/filtering
            products = data.map(p => ({
                ...p,
                price: p.inventory?.price || 0, // Add top-level price for sorting
                quantity: p.inventory?.quantity || 0 // Add top-level quantity for sorting
            }));
            filteredProducts = [...products];
            currentPage = 1; // Reset to first page
            renderTable(); // Initial render
        } catch (error) {
            console.error("Lỗi khi tải dữ liệu sản phẩm:", error);
            productTableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 20px; color: red;">Không thể tải dữ liệu sản phẩm. Lỗi: ${error.message}</td></tr>`;
            showToast(`Lỗi tải dữ liệu: ${error.message}`, "error");
        }
    }

    // Render the product table content
    function renderTable() {
        sortProducts(); // Apply sorting before rendering
        productTableBody.innerHTML = ''; // Clear existing rows

        const startIndex = (currentPage - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        const productsToRender = filteredProducts.slice(startIndex, endIndex);

        if (productsToRender.length === 0) {
             productTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Không tìm thấy sản phẩm nào.</td></tr>';
        } else {
            productsToRender.forEach(product => {
                const row = document.createElement('tr');
                const status = product.quantity > 0 ? 'Hoạt động' : 'Hết hàng';
                const statusClass = product.quantity > 0 ? 'active' : 'inactive';
                // Use optional chaining for safety, though we added defaults in fetch
                const priceDisplay = (product.price || 0).toLocaleString('vi-VN');
                const imageSrc = product.hinhAnh ? `/images/products/${encodeURIComponent(product.hinhAnh)}` : '/images/placeholder.png'; // Fallback image

                row.innerHTML = `
                    <td><input type="checkbox" class="product-checkbox" data-id="${product.id}"></td>
                    <td>${product.id}</td>
                    <td><img src="${imageSrc}" alt="${product.ten}" class="product-image" onerror="this.onerror=null; this.src='/images/placeholder.png';"></td>
                    <td title="${product.ten}">${product.ten.length > 30 ? product.ten.substring(0, 30) + '...' : product.ten}</td>
                    <td>${product.loaiHienThi || product.loai || 'N/A'}</td>
                    <td>${priceDisplay} đ</td>
                    <td>${product.quantity || 0}</td>
                    <td><span class="status ${statusClass}">${status}</span></td>
                    <td>
                        <div class="action-wrapper">
                             <button class="action-btn" title="Thao tác">...</button> <!-- Simple dots -->
                            <div class="action-dropdown">
                                <a href="/product_detail?id=${product.id}" target="_blank" class="action-item">Xem chi tiết</a>
                                <a href="/edit_product?id=${product.id}" class="action-item">Sửa</a>
                                <a href="#" class="action-item delete-btn" data-id="${product.id}">Xóa</a>
                            </div>
                        </div>
                    </td>
                `;
                productTableBody.appendChild(row);
            });
        }
        updatePaginationControls();
        updateSelectAllCheckboxState(); // Update select all based on current page checks
        toggleDeleteManyButton(); // Update delete many button visibility
    }

    // --- Event Listeners ---

    // Search Input
    searchInput.addEventListener('input', () => {
        filterProducts();
        renderTable();
    });

    // Select All Checkbox
    selectAllCheckbox.addEventListener('change', function() {
        const checkboxesOnPage = productTableBody.querySelectorAll(".product-checkbox");
        checkboxesOnPage.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        toggleDeleteManyButton();
    });

    // Individual Product Checkbox (using event delegation)
    productTableBody.addEventListener('change', function(e) {
        if (e.target.classList.contains('product-checkbox')) {
            updateSelectAllCheckboxState();
            toggleDeleteManyButton();
        }
    });

    // Delete Button (using event delegation)
     productTableBody.addEventListener('click', function(e) {
         if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
             e.preventDefault();
             const button = e.target.classList.contains('delete-btn') ? e.target : e.target.closest('.delete-btn');
             const productId = button.getAttribute('data-id');
             if (productId) {
                showSingleDeleteModal(productId);
             }
         }
     });

    // Delete Many Button
    deleteManyBtn.addEventListener('click', function() {
        const checkedCheckboxes = productTableBody.querySelectorAll(".product-checkbox:checked");
        const productIds = Array.from(checkedCheckboxes).map(checkbox => checkbox.getAttribute("data-id"));

        if (productIds.length === 0) {
            showToast("Vui lòng chọn ít nhất một sản phẩm để xóa!", "warning");
            return;
        }
        showMultiDeleteModal(productIds);
    });

    // Pagination Buttons
    prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    });

    nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTable();
        }
    });

    // Sorting Headers (using event delegation)
    document.querySelector('.product-table thead').addEventListener('click', (e) => {
         if (e.target.classList.contains('sortable')) {
             const column = e.target.getAttribute('data-sort');
             if (sortState.column === column) {
                 sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
             } else {
                 sortState.column = column;
                 sortState.direction = 'asc';
             }
             // Remove sorting indicators from other columns
             document.querySelectorAll('.product-table th.sortable').forEach(th => {
                 th.classList.remove('sort-asc', 'sort-desc');
             });
             // Add indicator to current column
             e.target.classList.add(sortState.direction === 'asc' ? 'sort-asc' : 'sort-desc');
             renderTable(); // Re-render with new sort order
         }
     });

    // --- Helper Functions ---

    // Filter products based on search term
    function filterProducts() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        if (!searchTerm) {
            filteredProducts = [...products];
        } else {
            filteredProducts = products.filter(product =>
                product.ten.toLowerCase().includes(searchTerm) ||
                (product.loaiHienThi && product.loaiHienThi.toLowerCase().includes(searchTerm)) ||
                product.id.toLowerCase().includes(searchTerm) // Search by ID as well
            );
        }
        currentPage = 1; // Reset to page 1 after filtering
    }

    // Sort products based on current sort state
    function sortProducts() {
        if (!sortState.column) return; // No sorting applied

        const { column, direction } = sortState;
        const multiplier = direction === 'asc' ? 1 : -1;

        filteredProducts.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];

             // Handle different data types for sorting
             if (column === 'price' || column === 'quantity') {
                 valA = Number(valA) || 0;
                 valB = Number(valB) || 0;
                 return (valA - valB) * multiplier;
             } else {
                 // Default to string comparison
                 valA = String(valA || '').toLowerCase();
                 valB = String(valB || '').toLowerCase();
                 if (valA < valB) return -1 * multiplier;
                 if (valA > valB) return 1 * multiplier;
                 return 0;
             }
        });
    }


    // Update state of "Select All" checkbox based on current page's checkboxes
    function updateSelectAllCheckboxState() {
        const checkboxesOnPage = productTableBody.querySelectorAll('.product-checkbox');
        if (checkboxesOnPage.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            return;
        }
        const checkedCount = productTableBody.querySelectorAll('.product-checkbox:checked').length;

        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === checkboxesOnPage.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    // Toggle visibility of "Delete Many" button
    function toggleDeleteManyButton() {
        const checkedCount = productTableBody.querySelectorAll(".product-checkbox:checked").length;
        if (checkedCount > 0) {
            deleteManyBtn.classList.add("visible");
            deleteManyBtn.textContent = `Xóa ${checkedCount} sản phẩm đã chọn`;
        } else {
            deleteManyBtn.classList.remove("visible");
             deleteManyBtn.textContent = `Xóa sản phẩm đã chọn`; // Reset text
        }
    }

    // Update pagination controls (buttons and page info)
    function updatePaginationControls() {
        const totalProducts = filteredProducts.length;
        const totalPages = Math.ceil(totalProducts / productsPerPage);

        pageInfoSpan.textContent = totalProducts > 0 ? `Trang ${currentPage} / ${totalPages}` : 'Không có dữ liệu';
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;

         // Disable selectAll if no products on the current page
         selectAllCheckbox.disabled = productTableBody.querySelectorAll('.product-checkbox').length === 0;
    }

    // --- Modal and Deletion Logic ---

    // Show confirmation modal for single product deletion
    function showSingleDeleteModal(productId) {
        const product = products.find(p => p.id === productId);
        const productName = product ? product.ten : `ID ${productId}`;
        showModal(`Xác nhận xóa sản phẩm`,
                  `<p style="color: #666666; margin-bottom: 20px;">Bạn có chắc chắn muốn xóa sản phẩm <strong>${productName}</strong>?</p>`,
                  `<button class="btn btn-danger" onclick="confirmSingleDelete('${productId}')">Xóa</button>
                   <button class="btn btn-secondary" onclick="closeModal()">Hủy</button>`);
    }

    // Show confirmation modal for multiple product deletion
    function showMultiDeleteModal(productIds) {
         showModal(`Xác nhận xóa nhiều sản phẩm`,
                   `<p style="color: #666666; margin-bottom: 20px;">Bạn có chắc chắn muốn xóa <strong>${productIds.length}</strong> sản phẩm đã chọn?</p>`,
                   // Pass the array as a JSON string to avoid issues with commas in product IDs if they ever occur
                   `<button class="btn btn-danger" onclick='confirmMultiDelete(${JSON.stringify(productIds)})'>Xóa ${productIds.length} sản phẩm</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Hủy</button>`);
    }

     // Generic Modal Function
     function showModal(title, contentHtml, footerHtml) {
         closeModal(); // Close any existing modal first
         const modal = document.createElement("div");
         modal.className = "modal";
         modal.id = "confirmActionModal";
         // Improved modal styling
         modal.style.cssText = `
             display: flex; justify-content: center; align-items: center;
             position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             background: rgba(0, 0, 0, 0.6); z-index: 1000;
             opacity: 0; transition: opacity 0.3s ease;
         `;
         modal.innerHTML = `
             <div style="background: #FFFFFF; width: 90%; max-width: 450px; padding: 25px 30px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s ease;">
                 <h3 style="color: #333333; margin-top: 0; margin-bottom: 15px; font-size: 1.3em;">${title}</h3>
                 ${contentHtml}
                 <div class="modal-actions" style="margin-top: 25px;">
                     ${footerHtml}
                 </div>
             </div>
         `;
         document.body.appendChild(modal);
         // Trigger transition
         setTimeout(() => {
             modal.style.opacity = '1';
             modal.querySelector('div').style.transform = 'scale(1)';
         }, 10); // Small delay ensures transition works
     }


    // Close any modal
    function closeModal() {
        const modal = document.getElementById("confirmActionModal");
        if (modal) {
            modal.style.opacity = '0';
            modal.querySelector('div').style.transform = 'scale(0.9)';
            setTimeout(() => modal.remove(), 300); 
        }
    }

    // Confirm single delete action
    async function confirmSingleDelete(productId) {
        loadingIndicator.style.display = 'block';
        closeModal();
        try {
            const response = await fetch(`/dishes/${productId}`, { method: 'DELETE' });
            const data = await response.json(); 

            if (response.ok) {
                showToast(data.message || `Xóa sản phẩm ${productId} thành công!`, "success");

                products = products.filter(p => p.id !== productId);
                filterProducts(); 
                const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
                if (currentPage > totalPages && totalPages > 0) {
                    currentPage = totalPages;
                } else if (filteredProducts.length === 0) {
                    currentPage = totalPages; 
                }
                renderTable();
            } else {
                throw new Error(data.message || `Lỗi ${response.status}: Không thể xóa sản phẩm.`);
            }
        } catch (error) {
            console.error(`Lỗi khi xóa sản phẩm ${productId}:`, error);
            showToast(`Lỗi khi xóa: ${error.message}`, "error");
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }


    // Confirm multiple delete action
    async function confirmMultiDelete(productIds) {
        if (!Array.isArray(productIds) || productIds.length === 0) {
             showToast("Không có ID sản phẩm nào để xóa.", "warning");
             return;
        }
        console.log("Xác nhận xóa các ID:", productIds);
        loadingIndicator.style.display = "block";
    closeModal();

    try {
        const response = await fetch("/dishes/bulk", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ids: productIds }),
        });

        if (!response.ok) {
            let errorMsg = `Lỗi ${response.status}: ${response.statusText}`;
            try {
                const errorData = await response.json();
                errorMsg = errorData.message || errorMsg;
            } catch (parseError) {
                console.warn("Không thể parse JSON lỗi từ server:", parseError);
            }
            throw new Error(errorMsg);
        }

        const data = await response.json();
        showToast(data.message || `Thực hiện xóa ${productIds.length} sản phẩm.`, "success");
        await fetchProducts();

    } catch (error) { 
        console.error("Lỗi khi xóa nhiều sản phẩm:", error);
        showToast(`Lỗi khi xóa nhiều: ${error.message}`, "error");
    } finally {
        loadingIndicator.style.display = "none";
        selectAllCheckbox.checked = false;
        toggleDeleteManyButton();
    }
    }


    function showToast(message, type = "info") { 
        toastElement.textContent = message;
        toastElement.className = `toast ${type} show`; 

        setTimeout(() => {
            toastElement.classList.remove("show");
        }, 3000);
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', fetchProducts);

  </script>
  <!-- <script src="../../assets/js/admin.js"></script> --> <!-- Assuming admin.js is not strictly needed for this page logic -->
</body>
</html>